name: Deploy PHP App to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Ã‰tape 1 : RÃ©cupÃ©rer le code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Ã‰tape 2 : Copier les fichiers sur EC2
    - name: Deploy to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "/var/www/daniel"
        rm: false  # Ne pas supprimer les fichiers existants
    
    # Ã‰tape 3 : Configurer l'application PHP sur EC2
    - name: Configure PHP application
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸš€ DÃ©ploiement de l'application PHP..."
          
          # 1. Aller dans le dossier
          cd /var/www/daniel
          
          # 2. VÃ©rifier les permissions
          echo "Configuration des permissions..."
          sudo chown -R www-data:www-data /var/www/daniel
          sudo chmod -R 755 /var/www/daniel
          sudo chmod -R 775 /var/www/daniel/storage  # Si vous avez un dossier storage
          
          # 3. VÃ©rifier l'installation PHP
          echo "VÃ©rification PHP..."
          php --version
          
          # 4. Configuration Nginx pour pointer vers public/
          echo "Configuration Nginx..."
          sudo bash -c 'cat > /etc/nginx/sites-available/daniel << EOF
          server {
              listen 80;
              server_name _;
              root /var/www/daniel/public;
              index index.php index.html index.htm;
              
              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }
              
              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                  include fastcgi_params;
              }
              
              location ~ /\.ht {
                  deny all;
              }
          }
          EOF'
          
          # 5. Activer le site
          sudo ln -sf /etc/nginx/sites-available/daniel /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # 6. Tester et redÃ©marrer Nginx
          echo "Test configuration Nginx..."
          sudo nginx -t
          sudo systemctl reload nginx
          
          # 7. RedÃ©marrer PHP-FPM si nÃ©cessaire
          sudo systemctl restart php8.1-fpm
          
          # 8. Installation Composer (si nÃ©cessaire)
          if [ -f "composer.json" ]; then
            echo "Installation des dÃ©pendances Composer..."
            composer install --no-dev --optimize-autoloader
          fi
          
          # 9. VÃ©rification finale
          echo "ðŸ“‹ VÃ©rification du dÃ©ploiement :"
          echo "- Dossier : $(pwd)"
          echo "- PropriÃ©taire : $(ls -ld .)"
          echo "- Fichiers principaux :"
          ls -la
          
          echo "âœ… DÃ©ploiement PHP terminÃ© avec succÃ¨s !"
          echo "ðŸŒ Votre application est disponible sur : http://${{ secrets.EC2_HOST }}"
