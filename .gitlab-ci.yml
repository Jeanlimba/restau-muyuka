# .gitlab-ci.yml - VERSION CORRECTE
image: alpine:latest

stages:
  - test

test_connection:
  stage: test
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    
    # 1. DÃ©coder la clÃ© depuis base64
    - echo "DÃ©codage de la clÃ© SSH..."
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    
    # 2. VÃ©rifier ce qui a Ã©tÃ© dÃ©codÃ©
    - echo "=== VÃ‰RIFICATION CLÃ‰ ==="
    - head -2 ~/.ssh/id_rsa
    - echo "..."
    - tail -2 ~/.ssh/id_rsa
    - echo "Taille: $(wc -l ~/.ssh/id_rsa) lignes"
    
    # 3. Extraire IP et user
    - REAL_HOST=$(echo "$EC2_HOST" | sed 's/^ip_//')
    - REAL_USER=$(echo "$EC2_USER" | sed 's/^user_//')
    
    # 4. Ajouter l'hÃ´te aux known_hosts
    - ssh-keyscan -H "$REAL_HOST" >> ~/.ssh/known_hosts
    
  script:
    - |
      echo "=== TEST DE CONNEXION ==="
      echo "IP: $REAL_HOST"
      echo "User: $REAL_USER"
      
      # Test simple
      ssh -o ConnectTimeout=10 "$REAL_USER@$REAL_HOST" "echo 'ðŸŽ‰ Bonjour depuis GitLab CI/CD!'"
      
      # VÃ©rifier PHP
      ssh "$REAL_USER@$REAL_HOST" "which php && php --version | head -1"