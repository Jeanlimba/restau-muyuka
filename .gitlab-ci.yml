# .gitlab-ci.yml - VERSION CORRIGÃ‰E
image: alpine:latest

stages:
  - test

test_connection:
  stage: test
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - REAL_HOST=$(echo "$EC2_HOST" | sed 's/^ip_//')
    - REAL_USER=$(echo "$EC2_USER" | sed 's/^user_//')
    - ssh-keyscan -H "$REAL_HOST" >> ~/.ssh/known_hosts
  script:
    - |
      echo "=== TEST DE CONNEXION ==="
      echo "IP: $REAL_HOST"
      echo "User: $REAL_USER"
      ssh -o ConnectTimeout=10 "$REAL_USER@$REAL_HOST" "echo 'ðŸŽ‰ Bonjour depuis GitLab CI/CD!'"