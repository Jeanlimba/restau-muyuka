# .gitlab-ci.yml
image: alpine:latest

stages:
  - test

test_connection:
  stage: test
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    
    # D√©coder la cl√© SSH depuis base64
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    
    # Extraire IP et user r√©els
    - REAL_HOST=$(echo "$EC2_HOST" | sed 's/^ip_//')
    - REAL_USER=$(echo "$EC2_USER" | sed 's/^user_//')
    
    - ssh-keyscan -H "$REAL_HOST" >> ~/.ssh/known_hosts
  script:
    - |
      echo "=== TEST GITLAB CI/CD ==="
      echo "üñ•Ô∏è  EC2 IP: $REAL_HOST"
      echo "üë§ User: $REAL_USER"
      
      # Tester la connexion
      ssh -o ConnectTimeout=10 "$REAL_USER@$REAL_HOST" "
        echo '‚úÖ Connect√© √† EC2 avec succ√®s !'
        echo 'üìÖ Date: $(date)'
        echo 'üè† Hostname: $(hostname)'
        echo 'üì¶ PHP: $(php --version | head -1)'
        echo 'üåê Nginx: $(nginx -v 2>&1)'
        
        # V√©rifier le dossier
        echo 'üìÅ V√©rification /var/www/daniel:'
        ls -la /var/www/daniel/ 2>/dev/null || echo 'Dossier non cr√©√©'
      "